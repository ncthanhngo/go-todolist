# Chi Tiết Hoạt Động Component TokenProvider

## 1. Cấu Trúc Thư Mục

```
component/tokenprovider/
├── provider.go          # Định nghĩa interfaces (Provider, TokenPayload, Token)
└── jwt/
    └── jwt.go           # Implementation cụ thể sử dụng JWT

common/
└── token.go             # Struct TokenPayload implement interface
```

---

## 2. Sơ Đồ Quan Hệ Giữa Các Thực Thể

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              INTERFACE LAYER                                    │
│                         (component/tokenprovider/provider.go)                   │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────┐
    │                        Provider (interface)                           │
    │───────────────────────────────────────────────────────────────────────│
    │  + Generate(data TokenPayload, expiry int) (Token, error)             │
    │  + Validate(token string) (TokenPayload, error)                       │
    │  + SecretKey() string                                                 │
    └───────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ implements
                                      ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │                      jwtProvider (struct)                             │
    │                    (jwt/jwt.go:11-14)                                 │
    │───────────────────────────────────────────────────────────────────────│
    │  - prefix: string    (tiền tố, ví dụ: "jwt")                          │
    │  - secret: string    (SYSTEM_SECRET từ .env)                          │
    └───────────────────────────────────────────────────────────────────────┘


    ┌───────────────────────────────────────────────────────────────────────┐
    │                     TokenPayload (interface)                          │
    │                      (provider.go:14-17)                              │
    │───────────────────────────────────────────────────────────────────────│
    │  + UserId() int                                                       │
    │  + Role() string                                                      │
    └───────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ implements
                                      ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │                   common.TokenPayload (struct)                        │
    │                      (common/token.go:3-6)                            │
    │───────────────────────────────────────────────────────────────────────│
    │  + UId: int       `json:"user_id"`                                    │
    │  + URole: string  `json:"role"`                                       │
    │───────────────────────────────────────────────────────────────────────│
    │  + UserId() int    → return p.UId                                     │
    │  + Role() string   → return p.URole                                   │
    └───────────────────────────────────────────────────────────────────────┘


    ┌───────────────────────────────────────────────────────────────────────┐
    │                        Token (interface)                              │
    │                      (provider.go:19-21)                              │
    │───────────────────────────────────────────────────────────────────────│
    │  + GetToken() string                                                  │
    └───────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ implements
                                      ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │                        token (struct)                                 │
    │                      (jwt/jwt.go:25-29)                               │
    │───────────────────────────────────────────────────────────────────────│
    │  + Token: string      `json:"token"`   (JWT string)                   │
    │  + Created: time.Time `json:"created"` (Thời gian tạo)                │
    │  + Expiry: int        `json:"expiry"`  (Thời gian sống - giây)        │
    │───────────────────────────────────────────────────────────────────────│
    │  + GetToken() string  → return t.Token                                │
    └───────────────────────────────────────────────────────────────────────┘


    ┌───────────────────────────────────────────────────────────────────────┐
    │                        myClaim (struct)                               │
    │                      (jwt/jwt.go:21-24)                               │
    │───────────────────────────────────────────────────────────────────────│
    │  + PayLoad: common.TokenPayload  `json:"payload"`                     │
    │  + jwt.RegisteredClaims          (embedded struct từ jwt library)     │
    │     ├── ExpiresAt: *NumericDate  (exp - thời gian hết hạn)            │
    │     ├── IssuedAt: *NumericDate   (iat - thời gian phát hành)          │
    │     └── ID: string               (jti - JWT ID unique)                │
    └───────────────────────────────────────────────────────────────────────┘
```

---

## 3. Luồng Hoạt Động Hàm Generate()

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         HÀM Generate() - TẠO TOKEN                              │
│                            (jwt/jwt.go:40-64)                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

 INPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  data: TokenPayload (interface)     │  expiry: int                         │
 │  ├── UserId() → 123                 │  └── 2592000 (30 ngày = 30*24*60*60) │
 │  └── Role()   → "user"              │                                      │
 └─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 1: Lấy thời gian hiện tại (jwt/jwt.go:42)                                  │
│ ──────────────────────────────────────────────                                  │
│                                                                                 │
│   now := time.Now()                                                             │
│                                                                                 │
│   Ví dụ: 2024-01-05 10:30:00 +0700                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 2: Tạo JWT Claims (jwt/jwt.go:43-53)                                       │
│ ─────────────────────────────────────────                                       │
│                                                                                 │
│   t := jwt.NewWithClaims(jwt.SigningMethodHS256, myClaim{                       │
│                                                                                 │
│       ┌─────────────────────────────────────────────────────────────────────┐   │
│       │ common.TokenPayload{                     ← Custom Payload           │   │
│       │     UId:   data.UserId(),  → 123         ← Gọi method lấy user_id   │   │
│       │     URole: data.Role(),    → "user"      ← Gọi method lấy role      │   │
│       │ }                                                                   │   │
│       └─────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│       ┌─────────────────────────────────────────────────────────────────────┐   │
│       │ jwt.RegisteredClaims{                    ← Standard JWT Claims      │   │
│       │     ExpiresAt: jwt.NewNumericDate(                                  │   │
│       │         now.Add(time.Second * time.Duration(expiry))                │   │
│       │     ),                                   → 2024-02-04 10:30:00      │   │
│       │     IssuedAt: jwt.NewNumericDate(now),   → 2024-01-05 10:30:00      │   │
│       │     ID: fmt.Sprintf("%d", now.UnixNano())→ "1704426600000000000"    │   │
│       │ }                                                                   │   │
│       └─────────────────────────────────────────────────────────────────────┘   │
│   })                                                                            │
│                                                                                 │
│   SigningMethodHS256 = HMAC-SHA256 algorithm                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 3: Ký Token bằng Secret Key (jwt/jwt.go:54-57)                             │
│ ───────────────────────────────────────────────────                             │
│                                                                                 │
│   myToken, err := t.SignedString([]byte(j.secret))                              │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        QUÁ TRÌNH KÝ JWT                                 │   │
│   │─────────────────────────────────────────────────────────────────────────│   │
│   │                                                                         │   │
│   │   Header (base64):                                                      │   │
│   │   {"alg":"HS256","typ":"JWT"} → eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9    │   │
│   │                                                                         │   │
│   │   Payload (base64):                                                     │   │
│   │   {                                                                     │   │
│   │     "payload":{"user_id":123,"role":"user"},                            │   │
│   │     "exp":1707026600,                                                   │   │
│   │     "iat":1704426600,                                                   │   │
│   │     "jti":"1704426600000000000"                                         │   │
│   │   }                                                                     │   │
│   │   → eyJwYXlsb2FkIjp7InVzZXJfaWQiOjEyMywicm9sZSI6InVzZXIifX0...          │   │
│   │                                                                         │   │
│   │   Signature:                                                            │   │
│   │   HMACSHA256(                                                           │   │
│   │     base64UrlEncode(header) + "." + base64UrlEncode(payload),           │   │
│   │     secret                                                              │   │
│   │   ) → SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c                       │   │
│   │                                                                         │   │
│   │   Final Token:                                                          │   │
│   │   eyJhbGci...eyJwYXls...SflKxwRJ...                                     │   │
│   │   [header].[payload].[signature]                                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   if err != nil {                                                               │
│       return nil, err    ← Lỗi nếu không ký được                                │
│   }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 4: Trả về Token struct (jwt/jwt.go:59-63)                                  │
│ ──────────────────────────────────────────────                                  │
│                                                                                 │
│   return &token{                                                                │
│       Token:   myToken,    → "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."          │
│       Created: now,        → 2024-01-05 10:30:00                                │
│       Expiry:  expiry,     → 2592000                                            │
│   }, nil                                                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
 OUTPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  Token (interface)                  │  error                               │
 │  └── GetToken() string              │  └── nil (success)                   │
 │      → "eyJhbGciOiJIUzI1..."        │                                      │
 └─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Luồng Hoạt Động Hàm Validate()

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        HÀM Validate() - XÁC THỰC TOKEN                          │
│                            (jwt/jwt.go:66-82)                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

 INPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  myToken: string                                                            │
 │  └── "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXlsb2FkIjp7..."             │
 └─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 1: Parse và Verify Token (jwt/jwt.go:67-69)                                │
│ ────────────────────────────────────────────────                                │
│                                                                                 │
│   res, err := jwt.ParseWithClaims(                                              │
│       myToken,                       ← Token string cần validate                │
│       &myClaim{},                    ← Struct để decode claims vào              │
│       func(token *jwt.Token) (interface{}, error) {                             │
│           return []byte(j.secret), nil   ← Callback trả về secret key          │
│       },                                                                        │
│   )                                                                             │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                   QUÁ TRÌNH PARSE & VERIFY                              │   │
│   │─────────────────────────────────────────────────────────────────────────│   │
│   │                                                                         │   │
│   │   1. Tách token thành 3 phần: header.payload.signature                  │   │
│   │                                                                         │   │
│   │   2. Decode header (base64) → {"alg":"HS256","typ":"JWT"}               │   │
│   │                                                                         │   │
│   │   3. Decode payload (base64) → {                                        │   │
│   │        "payload": {"user_id": 123, "role": "user"},                     │   │
│   │        "exp": 1707026600,                                               │   │
│   │        "iat": 1704426600,                                               │   │
│   │        "jti": "1704426600000000000"                                     │   │
│   │      }                                                                  │   │
│   │                                                                         │   │
│   │   4. Gọi callback để lấy secret key                                     │   │
│   │                                                                         │   │
│   │   5. Tính lại signature:                                                │   │
│   │      expectedSig = HMACSHA256(header + "." + payload, secret)           │   │
│   │                                                                         │   │
│   │   6. So sánh expectedSig với signature trong token                      │   │
│   │      → Nếu khớp: Token hợp lệ (chưa bị sửa đổi)                         │   │
│   │      → Nếu không khớp: Token bị giả mạo                                 │   │
│   │                                                                         │   │
│   │   7. Kiểm tra thời gian hết hạn (exp)                                   │   │
│   │      → Nếu exp < now: Token đã hết hạn                                  │   │
│   │                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 2: Kiểm tra lỗi parse (jwt/jwt.go:70-72)                                   │
│ ─────────────────────────────────────────────                                   │
│                                                                                 │
│   if err != nil {                                                               │
│       return nil, tokenprovider.ErrInvalidToken                                 │
│   }                                                                             │
│                                                                                 │
│   Các lỗi có thể xảy ra:                                                        │
│   ├── Token format không đúng (không có 3 phần)                                 │
│   ├── Base64 decode thất bại                                                    │
│   ├── Signature không khớp (token bị sửa đổi)                                   │
│   └── Token đã hết hạn (exp < now)                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 3: Kiểm tra Token Valid (jwt/jwt.go:74-76)                                 │
│ ───────────────────────────────────────────────                                 │
│                                                                                 │
│   if !res.Valid {                                                               │
│       return nil, tokenprovider.ErrInvalidToken                                 │
│   }                                                                             │
│                                                                                 │
│   res.Valid = true khi:                                                         │
│   ├── Signature hợp lệ                                                          │
│   ├── Token chưa hết hạn                                                        │
│   └── Tất cả claims được parse thành công                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 4: Type Assertion để lấy Claims (jwt/jwt.go:77-80)                         │
│ ───────────────────────────────────────────────────────                         │
│                                                                                 │
│   claims, ok := res.Claims.(*myClaim)                                           │
│   if !ok {                                                                      │
│       return nil, tokenprovider.ErrInvalidToken                                 │
│   }                                                                             │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  claims = &myClaim{                                                     │   │
│   │      PayLoad: common.TokenPayload{                                      │   │
│   │          UId:   123,                                                    │   │
│   │          URole: "user",                                                 │   │
│   │      },                                                                 │   │
│   │      RegisteredClaims: jwt.RegisteredClaims{                            │   │
│   │          ExpiresAt: 1707026600,                                         │   │
│   │          IssuedAt:  1704426600,                                         │   │
│   │          ID:        "1704426600000000000",                              │   │
│   │      },                                                                 │   │
│   │  }                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ BƯỚC 5: Trả về TokenPayload (jwt/jwt.go:81)                                     │
│ ───────────────────────────────────────────                                     │
│                                                                                 │
│   return &claims.PayLoad, nil                                                   │
│                                                                                 │
│   Trả về pointer tới common.TokenPayload                                        │
│   → Implement interface tokenprovider.TokenPayload                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
 OUTPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  TokenPayload (interface)           │  error                               │
 │  ├── UserId() → 123                 │  └── nil (success)                   │
 │  └── Role()   → "user"              │      hoặc ErrInvalidToken            │
 └─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Hàm Khởi Tạo NewTokenJWTProvider()

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    HÀM NewTokenJWTProvider() - CONSTRUCTOR                      │
│                            (jwt/jwt.go:16-19)                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

 INPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  prefix: string              │  secret: string                              │
 │  └── "jwt"                   │  └── os.Getenv("SYSTEM_SECRET")              │
 │                              │      (ví dụ: "my-super-secret-key")          │
 └─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ TẠO INSTANCE jwtProvider                                                        │
│                                                                                 │
│   func NewTokenJWTProvider(prefix string, secret string) *jwtProvider {         │
│       return &jwtProvider{                                                      │
│           prefix: prefix,    → "jwt"                                            │
│           secret: secret,    → "my-super-secret-key"                            │
│       }                                                                         │
│   }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
 OUTPUT:
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  *jwtProvider                                                               │
 │  └── Implement interface tokenprovider.Provider                             │
 │      ├── Generate(data, expiry) → Token                                     │
 │      ├── Validate(token) → TokenPayload                                     │
 │      └── SecretKey() → string                                               │
 └─────────────────────────────────────────────────────────────────────────────┘


 CÁCH SỬ DỤNG (main.go:35):
 ┌─────────────────────────────────────────────────────────────────────────────┐
 │  systemSecret := os.Getenv("SYSTEM_SECRET")                                 │
 │  tokenProvider := jwt.NewTokenJWTProvider("jwt", systemSecret)              │
 │                                                                             │
 │  // Sau đó inject vào middleware và handler                                 │
 │  middlewareAuth := middleware.RequireAuth(authStore, tokenProvider)         │
 └─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Các Lỗi Định Nghĩa Sẵn

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ERROR DEFINITIONS                                     │
│                        (provider.go:24-37)                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┬────────────────────────────┬──────────────────────────────┐
│     Error Name       │         Message            │         Khi nào xảy ra       │
├──────────────────────┼────────────────────────────┼──────────────────────────────┤
│ ErrNotFound          │ "Token not found"          │ Token không tồn tại          │
├──────────────────────┼────────────────────────────┼──────────────────────────────┤
│ ErrEndcodingToken    │ "Err endconding token"     │ Lỗi khi encode/ký token      │
├──────────────────────┼────────────────────────────┼──────────────────────────────┤
│ ErrInvalidToken      │ "Err invalid token"        │ Token không hợp lệ:          │
│                      │                            │ - Sai format                 │
│                      │                            │ - Signature không khớp       │
│                      │                            │ - Đã hết hạn                 │
│                      │                            │ - Bị sửa đổi                 │
└──────────────────────┴────────────────────────────┴──────────────────────────────┘
```

---

## 7. Tổng Kết Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              TỔNG KẾT FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   LOGIN     │
                              └──────┬──────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  1. User gửi email + password  │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  2. Verify password với DB     │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  3. Tạo TokenPayload           │
                    │     {user_id, role}            │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  4. Generate() tạo JWT         │
                    │     - Tạo claims               │
                    │     - Ký bằng HMAC-SHA256      │
                    │     - Trả về token string      │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  5. Trả token cho client       │
                    └────────────────────────────────┘


                              ┌─────────────┐
                              │  API CALL   │
                              └──────┬──────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  1. Client gửi token trong     │
                    │     Authorization header       │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  2. Middleware extract token   │
                    └────────────────┬───────────────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
                    │  3. Validate() kiểm tra token  │
                    │     - Parse JWT                │
                    │     - Verify signature         │
                    │     - Check expiry             │
                    └────────────────┬───────────────┘
                                     │
                          ┌──────────┴──────────┐
                          ▼                     ▼
                    ┌───────────┐         ┌───────────┐
                    │  VALID    │         │  INVALID  │
                    └─────┬─────┘         └─────┬─────┘
                          │                     │
                          ▼                     ▼
                    ┌───────────┐         ┌───────────┐
                    │ Find user │         │ Return    │
                    │ from DB   │         │ 401 Error │
                    └─────┬─────┘         └───────────┘
                          │
                          ▼
                    ┌───────────┐
                    │ Set user  │
                    │ to context│
                    └─────┬─────┘
                          │
                          ▼
                    ┌───────────┐
                    │ Call Next │
                    │ Handler   │
                    └───────────┘
```
